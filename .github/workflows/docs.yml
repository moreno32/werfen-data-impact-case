name: ðŸ“š Documentation Update

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'docs/**'
      - 'README.md'
      - 'dbt_project/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================
  # JOB 1: DOCUMENTATION VALIDATION
  # ==========================================
  validate-docs:
    name: âœ… Validate Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ Install Documentation Tools
      run: |
        pip install mkdocs mkdocs-material markdown-include
        
    - name: âœ… Validate Markdown Syntax
      run: |
        echo "ðŸ“‹ Validating markdown files..."
        
        # Check for broken markdown syntax
        find docs/ -name "*.md" -exec python -c "
        import sys
        import re
        
        file_path = sys.argv[1]
        print(f'Checking {file_path}...')
        
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
            
        # Check for common markdown issues
        issues = []
        
        # Check for malformed headers
        if re.search(r'^#{7,}', content, re.MULTILINE):
            issues.append('Headers with more than 6 levels found')
            
        # Check for unmatched code blocks
        code_blocks = content.count('```')
        if code_blocks % 2 != 0:
            issues.append('Unmatched code blocks found')
            
        # Check for empty links
        if re.search(r'\[.*?\]\(\s*\)', content):
            issues.append('Empty links found')
            
        if issues:
            print(f'âŒ Issues in {file_path}:')
            for issue in issues:
                print(f'  - {issue}')
            sys.exit(1)
        else:
            print(f'âœ… {file_path} is valid')
        " {} \;
        
    - name: ðŸ” Check Documentation Completeness
      run: |
        echo "ðŸ“Š Checking documentation completeness..."
        
        # Required documentation files
        REQUIRED_DOCS=(
          "docs/README_documentacion.md"
          "README.md"
        )
        
        for doc in "${REQUIRED_DOCS[@]}"; do
          if [ -f "$doc" ]; then
            echo "âœ… $doc exists"
          else
            echo "âŒ $doc missing"
            exit 1
          fi
        done
        
        # Check for component documentation
        COMPONENTS=("logging" "security" "performance" "portability" "distributed")
        
        for component in "${COMPONENTS[@]}"; do
          if [ -d "src/$component" ]; then
            # Check if component is documented
            if grep -q "$component" docs/*.md README.md; then
              echo "âœ… $component component is documented"
            else
              echo "âš ï¸ $component component may need documentation"
            fi
          fi
        done

  # ==========================================
  # JOB 2: GENERATE DEPLOYMENT GUIDE
  # ==========================================
  deployment-guide:
    name: ðŸ“– Generate Deployment Guide
    runs-on: ubuntu-latest
    needs: validate-docs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“– Generate CI/CD Deployment Guide
      run: |
        echo "ðŸ“š Generating CI/CD deployment guide..."
        
        cat > docs/guia_cicd_deployment.md << 'EOF'
        # ðŸš€ GuÃ­a de CI/CD y Deployment
        
        Esta guÃ­a explica el pipeline CI/CD implementado para el proyecto Werfen Data Pipeline.
        
        ## ðŸ“‹ Tabla de Contenidos
        
        1. [VisiÃ³n General](#visiÃ³n-general)
        2. [Workflows de GitHub Actions](#workflows-de-github-actions)
        3. [Equivalencias AWS](#equivalencias-aws)
        4. [ConfiguraciÃ³n de Entornos](#configuraciÃ³n-de-entornos)
        5. [Proceso de Deployment](#proceso-de-deployment)
        6. [Monitoreo y Alertas](#monitoreo-y-alertas)
        7. [Troubleshooting](#troubleshooting)
        
        ## ðŸŽ¯ VisiÃ³n General
        
        El pipeline CI/CD estÃ¡ diseÃ±ado para ser **simple pero enterprise-ready**, ideal para POCs que necesitan escalabilidad hacia AWS.
        
        ### CaracterÃ­sticas Principales:
        - âœ… **Continuous Integration** completo
        - âœ… **Continuous Deployment** por entornos
        - âœ… **Security Scanning** automatizado
        - âœ… **Documentation** auto-generada
        - âœ… **AWS-ready** con equivalencias 1:1
        
        ## ðŸ”§ Workflows de GitHub Actions
        
        ### 1. ðŸ”§ Continuous Integration (ci.yml)
        
        **Trigger:** Push/PR a main, develop, feature/*
        
        **Jobs:**
        1. **Code Quality & Security** - Linting, formatting, security scan
        2. **Component Testing** - Test individual de cada componente
        3. **Integration Testing** - Test de integraciÃ³n completo
        4. **Build Validation** - ValidaciÃ³n de build y packaging
        5. **Deployment Readiness** - VerificaciÃ³n pre-deployment
        
        ### 2. ðŸš€ Continuous Deployment (cd.yml)
        
        **Trigger:** Push a main + CI success
        
        **Jobs:**
        1. **Deployment Preparation** - DeterminaciÃ³n de entorno y matriz
        2. **Deploy Components** - Deployment paralelo por componente
        3. **Integration Validation** - ValidaciÃ³n end-to-end
        4. **Post-Deployment** - Notificaciones y rollback
        
        ### 3. ðŸ›¡ï¸ Security Scanning (security.yml)
        
        **Trigger:** Schedule (lunes 2 AM) + PRs importantes
        
        **Jobs:**
        1. **Dependency Scan** - Vulnerabilidades en dependencias
        2. **Code Analysis** - AnÃ¡lisis estÃ¡tico de seguridad
        3. **Secrets Scan** - DetecciÃ³n de secretos hardcodeados
        4. **Infrastructure Scan** - Seguridad de configuraciÃ³n
        
        ### 4. ðŸ“š Documentation Update (docs.yml)
        
        **Trigger:** Push a main/develop + cambios en docs
        
        **Jobs:**
        1. **Validate Documentation** - ValidaciÃ³n de markdown
        2. **Generate Deployment Guide** - Esta guÃ­a
        
        ## ðŸŽ¯ Equivalencias AWS
        
        | GitHub Actions | AWS Service | FunciÃ³n |
        |----------------|-------------|---------|
        | **GitHub Actions** | **CodePipeline + CodeBuild** | OrquestaciÃ³n CI/CD |
        | **GitHub Artifacts** | **S3 + CodeArtifact** | Almacenamiento de artifacts |
        | **GitHub Secrets** | **Secrets Manager** | GestiÃ³n de secretos |
        | **GitHub Environments** | **CodeDeploy + ECS** | Deployment por entornos |
        | **Security Scanning** | **Inspector + GuardDuty** | AnÃ¡lisis de seguridad |
        | **Auto-docs** | **CodeGuru + CloudFormation** | DocumentaciÃ³n automÃ¡tica |
        
        ## âš™ï¸ ConfiguraciÃ³n de Entornos
        
        ### Development
        - **Componentes:** Airflow + dbt
        - **Trigger:** Feature branches
        - **ValidaciÃ³n:** Tests bÃ¡sicos
        
        ### Staging  
        - **Componentes:** Airflow + dbt + S3 sync
        - **Trigger:** Push a main
        - **ValidaciÃ³n:** Tests completos + integraciÃ³n
        
        ### Production
        - **Componentes:** Airflow + dbt + S3 sync + Monitoring
        - **Trigger:** Manual (workflow_dispatch)
        - **ValidaciÃ³n:** Tests completos + health checks + rollback
        
        ## ðŸš€ Proceso de Deployment
        
        ### Deployment AutomÃ¡tico (Staging)
        
        1. Push to main â†’ CI Pipeline
        2. CI Success â†’ CD Pipeline
        3. Deploy Components (paralelo)
        4. Integration Tests
        5. Success/Rollback
        
        ### Deployment Manual (Production)
        
        1. **Trigger Manual:** Actions > CD > Run workflow > production
        2. **Review:** Validar deployment plan
        3. **Execute:** Deployment paralelo por componente
        4. **Validate:** Health checks automÃ¡ticos
        5. **Monitor:** Observabilidad completa
        
        ## ðŸ“Š Monitoreo y Alertas
        
        ### MÃ©tricas Monitoreadas
        - âœ… **Build Success Rate** - Porcentaje de builds exitosos
        - âœ… **Deployment Frequency** - Frecuencia de deployments
        - âœ… **Lead Time** - Tiempo desde commit hasta deployment
        - âœ… **Mean Time to Recovery** - Tiempo de recuperaciÃ³n
        
        ### Alertas Configuradas
        - ðŸš¨ **Build Failures** - NotificaciÃ³n inmediata
        - ðŸš¨ **Security Issues** - Alertas de seguridad
        - ðŸš¨ **Deployment Failures** - Fallos en production
        - ðŸ“Š **Weekly Reports** - Resumen semanal
        
        ## ðŸ”§ Troubleshooting
        
        ### Problemas Comunes
        
        #### CI Pipeline Falla
        1. Ir a Actions tab
        2. Seleccionar run fallido
        3. Expandir job con error
        4. Revisar logs detallados
        
        #### Deployment Falla
        1. Ir al Ãºltimo deployment exitoso
        2. Re-run workflow
        3. O trigger manual rollback
        
        #### Security Scan Issues
        1. Descargar artifacts de security scan
        2. Revisar JSON reports
        3. Aplicar fixes necesarios
        4. Re-run pipeline
        
        ## ðŸŽ¯ MigraciÃ³n a AWS
        
        ### Roadmap de MigraciÃ³n (4 semanas)
        
        **Semana 1: Setup Infrastructure**
        - Configurar CodePipeline + CodeBuild
        - Migrar secrets a Secrets Manager
        - Setup S3 buckets para artifacts
        
        **Semana 2: Pipeline Migration**
        - Migrar workflows a CodeBuild specs
        - Configurar triggers y webhooks
        - Setup environments en CodeDeploy
        
        **Semana 3: Security & Monitoring**
        - Configurar Inspector + GuardDuty
        - Setup CloudWatch + X-Ray
        - Configurar alertas SNS
        
        **Semana 4: Testing & Go-Live**
        - Testing completo del pipeline
        - Rollback procedures
        - Go-live y monitoring
        
        ### Costos Estimados AWS
        
        | Servicio | Costo Mensual | Notas |
        |----------|---------------|-------|
        | CodePipeline | $1/pipeline | ~$10/mes (10 pipelines) |
        | CodeBuild | $0.005/min | ~$50/mes (1000 mins) |
        | S3 Storage | $0.023/GB | ~$5/mes (200 GB) |
        | Secrets Manager | $0.40/secret | ~$20/mes (50 secrets) |
        | Inspector | $0.15/assessment | ~$15/mes (100 scans) |
        | **Total** | **~$100/mes** | **vs $300/mes CI/CD tradicional** |
        
        ## ðŸ“ž Soporte
        
        Para problemas con el pipeline CI/CD:
        
        1. **Revisar esta documentaciÃ³n**
        2. **Consultar logs en GitHub Actions**
        3. **Revisar issues del repositorio**
        4. **Contactar al equipo DevOps**
        
        ---
        
        *DocumentaciÃ³n generada automÃ¡ticamente*
        EOF
        
        echo "âœ… CI/CD deployment guide generated"
        
    - name: ðŸ“Š Upload Deployment Guide
      uses: actions/upload-artifact@v3
      with:
        name: deployment-guide
        path: docs/guia_cicd_deployment.md 